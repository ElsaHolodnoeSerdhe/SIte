<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Чат поддержки</title>
    <style>
        :root {
            --primary: #5181B8;
            --secondary: #5E81A8;
            --bg-color: #f5f5f5;
            --text-color: #333;
            --border-color: #ddd;
            --my-message-bg: #e1f3fb;
            --their-message-bg: #fff;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        /* Контейнер чата */
        .chat-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 350px;
            height: 500px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            z-index: 1000;
        }
        
        /* Шапка чата */
        .chat-header {
            background: var(--primary);
            color: white;
            padding: 12px 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .chat-title {
            font-weight: 500;
        }
        
        .chat-close {
            cursor: pointer;
            font-size: 20px;
        }
        
        /* Тело чата */
        .chat-body {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background-color: var(--bg-color);
        }
        
        .message {
            margin-bottom: 12px;
            max-width: 80%;
            padding: 8px 12px;
            border-radius: 12px;
            word-wrap: break-word;
        }
        
        .my-message {
            background-color: var(--my-message-bg);
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }
        
        .their-message {
            background-color: var(--their-message-bg);
            margin-right: auto;
            border-bottom-left-radius: 4px;
            box-shadow: 0 1px 1px rgba(0,0,0,0.05);
        }
        
        .message-time {
            font-size: 11px;
            color: #999;
            margin-top: 4px;
            text-align: right;
        }
        
        /* Форма ввода */
        .chat-input {
            display: flex;
            border-top: 1px solid var(--border-color);
            padding: 10px;
            background: white;
        }
        
        .chat-input input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 20px;
            outline: none;
        }
        
        .chat-input button {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 20px;
            padding: 8px 15px;
            margin-left: 8px;
            cursor: pointer;
        }
        
        /* Кнопка открытия чата */
        .chat-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: var(--primary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            z-index: 1001;
        }
        
        /* Индикатор новых сообщений */
        .unread-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff3347;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <!-- Кнопка открытия чата -->
    <div class="chat-toggle" id="chatToggle">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M19.25 3.75H4.75C3.64543 3.75 2.75 4.64543 2.75 5.75V18.25C2.75 19.3546 3.64543 20.25 4.75 20.25H19.25C20.3546 20.25 21.25 19.3546 21.25 18.25V5.75C21.25 4.64543 20.3546 3.75 19.25 3.75Z" stroke="white" stroke-width="1.5"/>
            <path d="M7.5 8.75H16.5" stroke="white" stroke-width="1.5" stroke-linecap="round"/>
            <path d="M7.5 12.75H13.5" stroke="white" stroke-width="1.5" stroke-linecap="round"/>
        </svg>
        <div class="unread-badge" id="unreadBadge" style="display: none;">0</div>
    </div>

    <!-- Контейнер чата -->
    <div class="chat-container" id="chatContainer" style="display: none;">
        <div class="chat-header">
            <div class="chat-title">Чат поддержки</div>
            <div class="chat-close" id="chatClose">×</div>
        </div>
        <div class="chat-body" id="chatBody">
            <div class="message their-message">
                Добрый день! Чем можем помочь?
                <div class="message-time">12:30</div>
            </div>
        </div>
        <div class="chat-input">
            <input type="text" id="messageInput" placeholder="Введите сообщение...">
            <button id="sendButton">Отпр.</button>
        </div>
    </div>

    <script>
        // Конфигурация
        const COMMUNITY_ID = 229889746; // Замените на ID вашего сообщества
        const ACCESS_TOKEN = 'vk1.a.0PfuQEEFy7w4W-jNyhxsMyi2cn_5MUSTEJWo8V5vrZjuFLiNgJB8p0AJlaGEiDHf4lFYJbRZrbkS-BhkfF8BRbi42FUPnhYiLRI3ZX0tVLrrUtNlDyCb3zwjui_loSwrs7gjDKD_8iwhj8bloWr5PveLs4tIUvBdxK5p0_KDqv6o9yh1lNPDDSmQXLoSEKOOxsQZqRY2ZrygRtIk7_43mAа'; // Получите в настройках сообщества
        
        // Состояние чата
        let chatState = {
            isOpen: false,
            unreadCount: 0,
            messages: [
                {
                    text: "Добрый день! Чем можем помочь?",
                    isMy: false,
                    time: "12:30"
                }
            ]
        };
        
        // Элементы DOM
        const chatContainer = document.getElementById('chatContainer');
        const chatToggle = document.getElementById('chatToggle');
        const chatClose = document.getElementById('chatClose');
        const chatBody = document.getElementById('chatBody');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const unreadBadge = document.getElementById('unreadBadge');
        
        // Отправка сообщения через VK API
        async function sendMessage() {
            const text = messageInput.value.trim();
            if (!text) return;
            
            // Добавляем сообщение в интерфейс
            addMessage(text, true);
            messageInput.value = '';
            
            try {
                // Отправка сообщения через API ВК
                const response = await fetch(`https://api.vk.com/method/messages.send?peer_id=-${COMMUNITY_ID}&message=${encodeURIComponent(text)}&access_token=${ACCESS_TOKEN}&v=5.131&random_id=${Math.floor(Math.random() * 1e10)}`);
                const data = await response.json();
                
                if (data.error) {
                    console.error("Ошибка отправки:", data.error);
                    addMessage("Не удалось отправить сообщение", false);
                }
            } catch (error) {
                console.error("Ошибка:", error);
                addMessage("Ошибка соединения", false);
            }
        }
        
        // Добавление сообщения в чат
        function addMessage(text, isMy) {
            const now = new Date();
            const time = `${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;
            
            const messageElement = document.createElement('div');
            messageElement.className = `message ${isMy ? 'my-message' : 'their-message'}`;
            messageElement.innerHTML = `
                ${text}
                <div class="message-time">${time}</div>
            `;
            
            chatBody.appendChild(messageElement);
            chatBody.scrollTop = chatBody.scrollHeight;
            
            // Сохраняем в состоянии
            chatState.messages.push({
                text,
                isMy,
                time
            });
            
            // Обновляем счетчик непрочитанных
            if (!chatState.isOpen && !isMy) {
                chatState.unreadCount++;
                updateUnreadBadge();
            }
        }
        
        // Обновление счетчика непрочитанных
        function updateUnreadBadge() {
            if (chatState.unreadCount > 0) {
                unreadBadge.style.display = 'flex';
                unreadBadge.textContent = chatState.unreadCount;
            } else {
                unreadBadge.style.display = 'none';
            }
        }
        
        // Получение новых сообщений (демо-версия без WebSocket)
        function checkNewMessages() {
            // В реальном приложении используйте LongPoll или WebSocket
            // Это демо-версия с имитацией ответа
            if (Math.random() > 0.7 && chatState.messages.length < 5) {
                setTimeout(() => {
                    const replies = [
                        "Спасибо за ваше сообщение!",
                        "Мы обработаем ваш запрос",
                        "Ожидайте ответа",
                        "Чем еще помочь?"
                    ];
                    const randomReply = replies[Math.floor(Math.random() * replies.length)];
                    addMessage(randomReply, false);
                }, 2000);
            }
        }
        
        // Обработчики событий
        chatToggle.addEventListener('click', () => {
            chatState.isOpen = !chatState.isOpen;
            chatContainer.style.display = chatState.isOpen ? 'flex' : 'none';
            
            if (chatState.isOpen) {
                chatState.unreadCount = 0;
                updateUnreadBadge();
            }
        });
        
        chatClose.addEventListener('click', () => {
            chatState.isOpen = false;
            chatContainer.style.display = 'none';
        });
        
        sendButton.addEventListener('click', sendMessage);
        
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        // Инициализация при загрузке
        document.addEventListener('DOMContentLoaded', () => {
            // Проверка новых сообщений каждые 5 секунд (демо)
            setInterval(checkNewMessages, 5000);
        });
    </script>
</body>
</html>
